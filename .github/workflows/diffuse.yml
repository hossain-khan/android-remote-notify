name: APK Size Analysis with Diffuse

on:
  pull_request:
    branches: [ "main" ]

env:
  EMAIL_API_KEY: 'FAKE_KEY_TO_PASS_CI'

jobs:
  diffuse:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # Required to post comments

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # Build PR APK
      - name: Build PR APK
        run: ./gradlew assembleRelease --parallel --daemon

      - name: List APK outputs
        run: |
          echo "Listing APK outputs:"
          find app/build/outputs/apk -name "*.apk"

      # Download base APK from latest release
      - name: Download base APK from latest release
        run: |
          # Get latest release info with error handling
          HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/release.json https://api.github.com/repos/${{ github.repository }}/releases/latest)
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Warning: Failed to fetch latest release (HTTP $HTTP_CODE), skipping comparison"
            echo "SKIP_DIFFUSE=true" >> $GITHUB_ENV
            exit 0
          fi
          
          LATEST_RELEASE=$(cat /tmp/release.json)
          
          # Extract APK download URL using jq (pre-installed on GitHub runners)
          APK_URL=$(echo "$LATEST_RELEASE" | jq -r '.assets[] | select(.name | endswith(".apk")) | .browser_download_url')
          
          if [ -z "$APK_URL" ] || [ "$APK_URL" = "null" ]; then
            echo "Warning: No APK found in latest release, skipping comparison"
            echo "SKIP_DIFFUSE=true" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "Downloading base APK from: $APK_URL"
          if ! curl -fL -o base.apk "$APK_URL"; then
            echo "Warning: Failed to download base APK, skipping comparison"
            echo "SKIP_DIFFUSE=true" >> $GITHUB_ENV
            exit 0
          fi
          
          # Verify the downloaded file exists and has content
          if [ ! -s base.apk ]; then
            echo "Warning: Downloaded APK is empty or missing, skipping comparison"
            echo "SKIP_DIFFUSE=true" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "Base APK downloaded successfully"

      # Run Diffuse comparison using the action
      - name: Run Diffuse
        id: diffuse
        if: env.SKIP_DIFFUSE != 'true'
        uses: usefulness/diffuse-action@v1
        continue-on-error: true
        with:
          old-file-path: base.apk
          new-file-path: app/build/outputs/apk/release/app-release-unsigned.apk

      # Post or update comment on PR
      - name: Find existing Diffuse comment
        uses: peter-evans/find-comment@v3
        id: find_comment
        if: (success() || failure()) && env.SKIP_DIFFUSE != 'true'
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: 'üìä APK Size Analysis'

      - name: Create or update PR comment
        uses: peter-evans/create-or-update-comment@v4
        if: env.SKIP_DIFFUSE != 'true'
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            ## üìä APK Size Analysis
            
            Comparing `${{ github.base_ref }}` (latest release) ‚Üí `${{ github.head_ref }}` (this PR)
            
            ${{ steps.diffuse.outputs.diff-gh-comment || '‚ö†Ô∏è Diffuse analysis failed. Check the workflow logs for details.' }}
            
            ---
            _Generated by [Diffuse](https://github.com/JakeWharton/diffuse) via [diffuse-action](https://github.com/usefulness/diffuse-action)_

      - name: Post skip comment if no base APK
        uses: peter-evans/create-or-update-comment@v4
        if: env.SKIP_DIFFUSE == 'true'
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## üìä APK Size Analysis
            
            ‚ö†Ô∏è No APK found in the latest release. APK size comparison skipped.
            
            Once an APK is uploaded to a release, future PRs will show size comparisons.
            
            ---
            _Generated by [Diffuse](https://github.com/JakeWharton/diffuse) via [diffuse-action](https://github.com/usefulness/diffuse-action)_

      # Upload APKs as artifacts for manual inspection
      - name: Upload PR APK
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-apk
          path: app/build/outputs/apk/release/app-release-unsigned.apk
          retention-days: 7

      - name: Upload comparison APKs
        uses: actions/upload-artifact@v4
        if: env.SKIP_DIFFUSE != 'true'
        with:
          name: apks-comparison
          path: |
            base.apk
            app/build/outputs/apk/release/app-release-unsigned.apk
          retention-days: 7
