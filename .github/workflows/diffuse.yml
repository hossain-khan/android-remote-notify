name: APK Size Analysis with Diffuse

on:
  pull_request:
    branches: [ "main" ]

env:
  EMAIL_API_KEY: 'FAKE_KEY_TO_PASS_CI'

jobs:
  diffuse:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # Required to post comments

    steps:
      # Checkout and build base (main) APK
      - name: Checkout base branch (main)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build base APK
        run: ./gradlew assembleRelease --parallel --daemon

      - name: Save base APK
        run: |
          mkdir -p /tmp/diffuse
          cp app/build/outputs/apk/release/app-release-unsigned.apk /tmp/diffuse/base.apk
          echo "Base APK saved from ${{ github.base_ref }} branch"

      # Clean build directory before building PR APK
      - name: Clean build
        run: ./gradlew clean

      # Checkout and build PR APK
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Build PR APK
        run: ./gradlew assembleRelease --parallel --daemon

      - name: List APK outputs
        run: |
          echo "Listing APK outputs:"
          find app/build/outputs/apk -name "*.apk"
          echo "Base APK:"
          ls -la /tmp/diffuse/base.apk

      # Run Diffuse comparison using the action
      - name: Run Diffuse
        id: diffuse
        uses: usefulness/diffuse-action@v1
        continue-on-error: true
        with:
          old-file-path: /tmp/diffuse/base.apk
          new-file-path: app/build/outputs/apk/release/app-release-unsigned.apk

      # Post or update comment on PR
      - name: Find existing Diffuse comment
        uses: peter-evans/find-comment@v3
        id: find_comment
        if: always()
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: 'üìä APK Size Analysis'

      - name: Create or update PR comment
        uses: peter-evans/create-or-update-comment@v4
        if: always()
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            ## üìä APK Size Analysis
            
            Comparing `${{ github.base_ref }}` ‚Üí `${{ github.head_ref }}` (this PR)
            
            ${{ steps.diffuse.outputs.diff-gh-comment || '‚ö†Ô∏è Diffuse analysis failed. Check the workflow logs for details.' }}
            
            ---
            _Generated by [Diffuse](https://github.com/JakeWharton/diffuse) via [diffuse-action](https://github.com/usefulness/diffuse-action)_

      # Upload APKs as artifacts for manual inspection
      - name: Upload base APK
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: base-apk
          path: /tmp/diffuse/base.apk
          retention-days: 7

      - name: Upload PR APK
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-apk
          path: app/build/outputs/apk/release/app-release-unsigned.apk
          retention-days: 7
